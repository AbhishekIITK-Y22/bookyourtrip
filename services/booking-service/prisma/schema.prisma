generator client {
  provider      = "prisma-client-js"
  output        = "./generated/client"
  binaryTargets = ["native", "linux-musl-arm64-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Provider {
  id          String   @id @default(cuid())
  userId      String   @unique  // Links to User in auth-service (one-to-one)
  name        String
  email       String?
  phone       String?
  description String?
  status      ProviderStatus @default(ACTIVE)
  routes      Route[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Route {
  id          String   @id @default(cuid())
  providerId  String
  source      String
  destination String
  trips       Trip[]
  provider    Provider @relation(fields: [providerId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Trip {
  id         String   @id @default(cuid())
  routeId    String
  departure  DateTime
  capacity   Int
  basePrice  Int
  seats      Seat[]
  bookings   Booking[]
  route      Route    @relation(fields: [routeId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Seat {
  id      String @id @default(cuid())
  tripId  String
  seatNo  String
  status  SeatStatus @default(AVAILABLE)
  trip    Trip   @relation(fields: [tripId], references: [id])

  @@unique([tripId, seatNo])
}

model Booking {
  id               String   @id @default(cuid())
  userId           String
  tripId           String
  seatNo           String
  priceApplied     Int
  state            BookingState @default(PENDING)
  paymentState     PaymentState @default(PENDING)
  idempotencyKey   String? @unique
  passengerName    String?
  passengerEmail   String?
  passengerPhone   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now()) @updatedAt
  trip             Trip     @relation(fields: [tripId], references: [id])

  // Removed @@unique([tripId, seatNo]) to allow historical bookings for same seat
  // Business logic validation prevents active double-booking
}

enum ProviderStatus {
  ACTIVE
  DISABLED
}

enum SeatStatus {
  AVAILABLE
  HELD
  SOLD
}

enum BookingState {
  PENDING
  CONFIRMED
  CANCELLED
  RESCHEDULED
}

enum PaymentState {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
}


